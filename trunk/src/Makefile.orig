########################################################################
## Makefile                                                           ##
##                                                                    ##
## This file is part of dvisvgm -- the DVI to SVG converter           ##
## Copyright (C) 2005-2006 Martin Gieseking <martin.gieseking@uos.de> ##
##                                                                    ##
## This program is free software; you can redistribute it and/or      ##
## modify it under the terms of the GNU General Public License        ##
## as published by the Free Software Foundation; either version 2     ##
## of the License, or (at your option) any later version.             ##
##                                                                    ##
## This program is distributed in the hope that it will be useful,    ##
## but WITHOUT ANY WARRANTY; without even the implied warranty of     ##
## MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the      ##
## GNU General Public License for more details.                       ##
##                                                                    ##
## You should have received a copy of the GNU General Public License  ##
## along with this program; if not, write to the Free Software        ##
## Foundation, Inc., 51 Franklin Street, Fifth Floor,                 ##
## Boston, MA 02110-1301, USA.                                        ##
########################################################################
# $Id: Makefile.orig,v 1.19 2006/01/06 14:30:40 mgieseki Exp $

EXE    = dvisvgm
STATIC = dvisvgm.a

AR     = ar
CC     = gcc
CCC    = g++
LINK   = g++

CCFLAGS = -g -Wall $(OPT)
LDFLAGS = 

SRCS = Bitmap.cpp BoundingBox.cpp Calculator.cpp CharmapTranslator.cpp DVIBBoxReader.cpp \
	  	 DVIReader.cpp DVIToSVG.cpp DVIToSVGActions.cpp FileFinder.cpp FileSystem.cpp FontInfo.cpp FontEngine.cpp \
		 FontMap.cpp FontGlyph.cpp GFReader.cpp GFTracer.cpp KPSFileFinder.cpp Message.cpp MetafontWrapper.cpp \
		 PageSize.cpp SVGFontEmitter.cpp SVGFontTraceEmitter.cpp TFM.cpp TransformationMatrix.cpp XMLDocument.cpp \
		 XMLNode.cpp XMLString.cpp 

EXESRCS = cmdline.c dvisvgm.cpp getopt.c getopt1.c gzstream.cpp

TESTS   = CalculatorTest.h PageSizeTest.h StreamCounterTest.h

OBJS    = $(SRCS:%.cpp=.objs/%.o)
EXEOBJS = $(addprefix .objs/, $(addsuffix .o, $(basename $(EXESRCS)))) 
ALLOBJS = $(OBJS) $(EXEOBJS)
DEPS    = $(ALLOBJS:%.o=.deps/%.d)
LIBS    = freetype potrace z
OS      = $(shell $(CC) -dumpmachine)

$(shell mkdir -p .deps)  # create directory for dependency files
$(shell mkdir -p .objs)  # create directory for object files

ifeq ($(OS),mingw32) 
	INCDIRS   = . .. /mingw/include/freetype2 /mingw/include/zlib
	LIBDIRS   = 
	DEFS      = -DMIKTEX -DHAVE_CONFIG_H
else                  # settings for UNIX-like operating systems
	INCDIRS   = .. /usr/include/freetype2
	LIBDIRS   = /usr/local/lib
	DEFS      = -DHAVE_CONFIG_H
endif


all: $(EXE) test-all

#EXEOBJS = .objs/cmdline.o .objs/getopt.o .objs/getopt1.o 

$(STATIC): $(OBJS)
	$(AR) -rs $@ $(OBJS) 

ifeq ($(OS),mingw32)
$(EXE): $(STATIC) $(EXEOBJS) miktex25-kps.a
	$(LINK) $(LDFLAGS) -o $@ $(EXEOBJS) $(STATIC) $(addprefix -l, $(LIBS)) miktex25-kps.a
#	$(LINK) $(LDFLAGS) -o $@ $(EXEOBJS) $(STATIC) $(addprefix -l, $(LIBS)) miktex-core.a miktex-kps.a
else
$(EXE): $(OBJS) $(EXEOBJS)
	$(LINK) $(LDFLAGS) -o $@ $(EXEOBJS) $(addprefix -l, $(LIBS)) -lkpathsea
endif


.objs/%.o: %.cpp 
	$(CCC) -o $@ -c -MMD $(CCFLAGS) $(DEFS) $(addprefix -I, $(INCDIRS)) $<	
	@cp -f .objs/$*.d .deps/$*.d
	@sed -e 's/^[^:]*: *//' -e 's/ *\\$$//' -e 's/$$/ :/' .objs/$*.d >>.deps/$*.d; 
	@rm -f .objs/$*.d

.objs/%.o: %.c
	$(CC) -o $@ -c -MMD $(CCFLAGS) $(DEFS) $(addprefix -I, $(INCDIRS)) $<	
	@cp -f .objs/$*.d .deps/$*.d
	@sed -e 's/^[^:]*: *//' -e 's/ *\\$$//' -e 's/$$/ :/' .objs/$*.d >>.deps/$*.d; 
	@rm -f .objs/$*.d

.def.a:
	dlltool -d $< -l $@ -U

-include $(DEPS)

test-all: .objs/test-all.o $(STATIC)
	$(LINK) $(LDFLAGS) -o $@ $^ $(addprefix -l, $(LIBS)) miktex-core.a miktex-kps.a

test-all.cpp: $(addprefix tests/, $(TESTS))
	cxxtestgen.pl --error-printer -o $@ $^

# gets version number from config.h generated by configure
cmdline.c: options.ggo
	gengetopt --unamed-opts --no-handle-help < $<
	sed -e "/Usage:/ s/\.\.\. \[FILES\]\.\.\./ dvifile/" $@ >$*.new
	rm $@
	mv $*.new $@

tags: 
	ctags -R
	
clean:
	rm -rf .deps .objs $(EXE) 
